<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PayPal Checkout Integration</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    label { display: block; margin-top: 10px; }
    input { width: 300px; padding: 6px; margin-top: 4px; }
    button { margin-top: 12px; padding: 8px 16px; }
    #paypal-button-container { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>PayPal Checkout Configuration</h2>
  <form id="config-form">
    <label for="clientId">Client ID</label>
    <input id="clientId" required>

    <label for="clientSecret">Client Secret</label>
    <input id="clientSecret" type="password" required>

    <label for="locale">Locale</label>
    <input id="locale" value="en_US">

    <label for="buyerCountry">Buyer Country</label>
    <input id="buyerCountry" value="US">

    <label for="enableFunding">Enable Funding (e.g., venmo)</label>
    <input id="enableFunding" value="">

    <button type="submit">Load PayPal Buttons</button>
  </form>

  <div id="paypal-button-container"></div>

  <script>
    document.getElementById('config-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const clientId = document.getElementById('clientId').value;
      const clientSecret = document.getElementById('clientSecret').value;
      const locale = document.getElementById('locale').value;
      const buyerCountry = document.getElementById('buyerCountry').value;
      const enableFunding = document.getElementById('enableFunding').value;

      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId, clientSecret })
      });

      const oldScript = document.getElementById('paypal-sdk');
      if (oldScript) oldScript.remove();

      const sdkUrl = new URL('https://www.paypal.com/sdk/js');
      sdkUrl.searchParams.set('client-id', clientId);
      if (locale) sdkUrl.searchParams.set('locale', locale);
      if (buyerCountry) sdkUrl.searchParams.set('buyer-country', buyerCountry);
      if (enableFunding) sdkUrl.searchParams.set('enable-funding', enableFunding);

      const script = document.createElement('script');
      script.src = sdkUrl.toString();
      script.id = 'paypal-sdk';
      script.onload = () => {
        paypal.Buttons({
          createOrder: async () => {
            const res = await fetch('/api/orders', { method: 'POST' });
            const data = await res.json();
            return data.id;
          },
          onApprove: async (data) => {
            const res = await fetch(`/api/orders/${data.orderID}/capture`, { method: 'POST' });
            const details = await res.json();
            alert(`Transaction completed by ${details.payer.name.given_name}`);
          }
        }).render('#paypal-button-container');
      };

      document.body.appendChild(script);
    });
  </script>
</body>
</html>
